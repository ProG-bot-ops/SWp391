<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Appointment Counter</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .counter { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0; font-size: 18px; }
        .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Appointment Counter</h1>
        
        <div class="counter">
            <strong>Counter Display:</strong>
            <p id="appointment-count">ƒêang t·∫£i...</p>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="debugData()">Debug Data</button>
            <button class="btn btn-success" onclick="fixCounter()">Fix Counter</button>
            <button class="btn btn-warning" onclick="testToday()">Test Today</button>
            <button class="btn btn-primary" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="data-display"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        // Mock console
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function debugData() {
            console.log('üîç === DEBUG DATA ===');
            
            // Ki·ªÉm tra appState
            if (window.appState) {
                console.log('‚úÖ appState found:', window.appState);
                console.log('üìä Appointments count:', window.appState.appointments?.length || 0);
                
                // Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
                displayAppointments(window.appState.appointments || []);
            } else {
                console.log('‚ùå appState not found');
            }
            
            // Ki·ªÉm tra localStorage
            const storedData = localStorage.getItem('allAppointments');
            if (storedData) {
                console.log('‚úÖ localStorage data found');
                const appointments = JSON.parse(storedData);
                console.log('üìä Stored appointments:', appointments.length);
                displayAppointments(appointments);
            } else {
                console.log('‚ùå No localStorage data');
            }
            
            // Ki·ªÉm tra AppointmentCounter
            if (window.AppointmentCounter) {
                console.log('‚úÖ AppointmentCounter found');
                console.log('üìä Methods:', Object.keys(window.AppointmentCounter));
            } else {
                console.log('‚ùå AppointmentCounter not found');
            }
        }
        
        function displayAppointments(appointments) {
            const displayDiv = document.getElementById('data-display');
            
            if (appointments.length === 0) {
                displayDiv.innerHTML = '<p>No appointments found</p>';
                return;
            }
            
            let html = '<h3>Appointments Data:</h3>';
            html += '<table class="data-table">';
            html += '<tr><th>ID</th><th>Patient</th><th>Date</th><th>Status</th><th>Parsed Date</th><th>Is Today</th></tr>';
            
            appointments.forEach((appointment, index) => {
                const parsedDate = window.AppointmentCounter?.parseDate?.(appointment.date);
                const isToday = parsedDate ? isDateToday(parsedDate) : false;
                
                html += `<tr>
                    <td>${appointment.id || index + 1}</td>
                    <td>${appointment.patientName || 'N/A'}</td>
                    <td>${appointment.date || 'N/A'}</td>
                    <td>${appointment.status || 'N/A'}</td>
                    <td>${parsedDate ? parsedDate.toISOString().split('T')[0] : 'Invalid'}</td>
                    <td>${isToday ? '‚úÖ YES' : '‚ùå NO'}</td>
                </tr>`;
            });
            
            html += '</table>';
            displayDiv.innerHTML = html;
        }
        
        function isDateToday(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const compareDate = new Date(date);
            compareDate.setHours(0, 0, 0, 0);
            return compareDate.getTime() === today.getTime();
        }
        
        function fixCounter() {
            console.log('üîß === FIXING COUNTER ===');
            
            // T·∫°o d·ªØ li·ªáu test v·ªõi ng√†y h√¥m nay
            const today = new Date().toISOString().split('T')[0];
            console.log('üìÖ Today is:', today);
            
            const testAppointments = [
                {
                    id: 1,
                    patientName: 'Nguy·ªÖn VƒÉn A',
                    doctorName: 'B√°c sƒ© Ho√†ng',
                    clinicName: 'Ph√≤ng kh√°m ƒêa khoa',
                    date: today, // S·ª≠ d·ª•ng ng√†y h√¥m nay
                    shift: 'Ca s√°ng',
                    status: 'scheduled'
                },
                {
                    id: 2,
                    patientName: 'Tr·∫ßn Th·ªã B',
                    doctorName: 'B√°c sƒ© Ph·∫°m',
                    clinicName: 'Ph√≤ng kh√°m Tim m·∫°ch',
                    date: today, // S·ª≠ d·ª•ng ng√†y h√¥m nay
                    shift: 'Ca chi·ªÅu',
                    status: 'inprogress'
                }
            ];
            
            // C·∫≠p nh·∫≠t appState
            window.appState = {
                appointments: testAppointments,
                isLoading: false,
                lastUpdate: new Date()
            };
            
            console.log('‚úÖ Test data created with today\'s date');
            
            // G·ªçi counter
            if (window.AppointmentCounter) {
                window.AppointmentCounter.load();
            }
            
            // Hi·ªÉn th·ªã d·ªØ li·ªáu
            displayAppointments(testAppointments);
        }
        
        function testToday() {
            console.log('üß™ === TESTING TODAY ===');
            
            const today = new Date();
            console.log('üìÖ Current date:', today.toISOString());
            console.log('üìÖ Today (00:00):', new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString());
            
            // Test v·ªõi c√°c format date kh√°c nhau
            const testDates = [
                today.toISOString().split('T')[0], // YYYY-MM-DD
                today.toLocaleDateString('en-CA'), // YYYY-MM-DD
                today.toLocaleDateString('vi-VN'), // DD/MM/YYYY
                today.toLocaleDateString('en-US')  // MM/DD/YYYY
            ];
            
            testDates.forEach(dateStr => {
                console.log(`üìÖ Testing date: ${dateStr}`);
                if (window.AppointmentCounter?.parseDate) {
                    const parsed = window.AppointmentCounter.parseDate(dateStr);
                    console.log(`   Parsed: ${parsed ? parsed.toISOString() : 'Invalid'}`);
                    console.log(`   Is today: ${parsed ? isDateToday(parsed) : 'N/A'}`);
                }
            });
        }
        
        // Load appointment-counter.js
        const script = document.createElement('script');
        script.src = './assets/js/AppointmentDashboardJS/appointment-counter.js';
        script.onload = function() {
            console.log('‚úÖ appointment-counter.js loaded');
        };
        script.onerror = function() {
            console.error('‚ùå Failed to load appointment-counter.js');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
